# Session Log: 2026-01-11 - Emulator Setup & Video Investigation

## Session Goal
Set up dual-emulator system for camera control + feed viewing for "gas knob experiment" (visual shift detection via PAN control).

## Key Discoveries

### 1. Camera is Cloud-Only (CRITICAL)
**All local ports are closed on the camera (192.168.29.137):**
```
Port 80: closed
Port 443: closed
Port 554: closed (RTSP)
Port 2020: closed (ONVIF)
```

**Implications:**
- pytapo/RTSP/ONVIF will NOT work - no local API
- Tapo app connects via TP-Link cloud relay
- **Android UI automation is the ONLY viable control method**
- Direct protocol reverse engineering requires MITM on cloud HTTPS traffic

### 2. Coordinate System
**Physical screen:** 720x1280 pixels (`adb shell wm size`)
**Logical coordinates (uiautomator):** 320x640 dp
**Density:** 160 dpi (`adb shell wm density`)

**IMPORTANT:** `adb shell input tap` uses **dp coordinates**, NOT physical pixels.
```bash
# CORRECT - use dp coordinates from uiautomator dump
adb shell input tap 160 603

# WRONG - don't scale to physical pixels
adb shell input tap 360 1206
```

### 3. Video Blackout Issue - ROOT CAUSE IDENTIFIED

**Symptom:** Video feed shows briefly (~split second) then blacks out.

**Observations:**
- Video DOES render initially (codec works)
- Then immediately goes black
- PAN/Tilt controls work correctly (verified via physical phone)
- Camera physically responds to emulator commands

**Root Cause (from logcat):**
```
MediaException{errorCode=-2016, method='null', message='Don't exist mqtt connection!'}
Client is not connected (32104)
```
- App uses **MQTT via TP-Link cloud relay** for video streaming
- MQTT connection fails/disconnects on emulator
- Control API uses different pathway (HTTP/REST) - that's why PAN works

**GPU Mode Testing:**
- Tested `-gpu host` (hardware) - blacks out
- Tested `-gpu swiftshader_indirect` (software) - blacks out
- **Conclusion: GPU is NOT the cause**

**Workaround Discovered:**
- "Cameras" tab shows static thumbnail without triggering live stream
- Thumbnail loads successfully without ANR
- Could be used for visual state verification without video

**Current status:** RESOLVED - MQTT cloud relay incompatibility with emulator

### 4. ANR "Not Responding" Issue
App occasionally shows "Application Not Responding" dialog.
**Status:** Needs investigation - may be related to video rendering failure

### 5. Camera Icon States (Home Screen)
| State | Icon | Label |
|-------|------|-------|
| Offline | Gray/muted | "Offline" |
| Online + Privacy ON | Normal | Connected but not streaming |
| Online + Privacy OFF | **Blue** | Actively streaming |

Screenshots saved:
- `camera-offline-home-screen.png`
- `camera-online-streaming-blue-icon.png`
- `camera-live-privacy-mode-active.png`

### 6. Startup Popup Flows
**Third-Party Services popup** appears on fresh launch:
1. Screen 1: Service list (Alexa, Google, SmartThings, IFTTT)
   - Dismiss: `adb shell input tap 160 603` (Maybe Later)
2. Screen 2: Confirmation tutorial
   - Dismiss: `adb shell input tap 160 565` (Got It)

**Privacy Mode** - Camera may be in privacy mode on connect:
- Exit: Tap "Exit Privacy Mode" button in camera live view

### 7. Emulator Setup
**Working configuration:**
```bash
./emulator/emulator -avd tapo_playstore -gpu host -no-snapshot -no-audio -no-boot-anim
```

**AVD details:**
- Name: tapo_playstore, tapo_worker2, tapo_worker3
- System image: android-34;google_apis_playstore;x86_64
- GPU: host (uses RTX 2060 SUPER)

**Dual emulator strategy:**
- Emulator 1 (5554): Feed viewing
- Emulator 2 (5556): PAN control
- Both can access same Tapo account simultaneously

## What Works
- [x] Emulator launches with KVM acceleration
- [x] Tapo app installs and runs
- [x] Camera connects (via cloud)
- [x] PAN/Tilt controls respond (verified on phone)
- [x] Privacy Mode toggle works
- [x] UI automation (tap, swipe) works
- [x] Screenshot capture works
- [x] uiautomator dump works

## What Doesn't Work
- [ ] Video feed display (blacks out after brief flash)
- [ ] Direct camera API (cloud-only, no local ports)
- [ ] pytapo connection (times out)
- [ ] RTSP stream (port closed)

## Login Flow Discovery (2026-01-11 Evening Session)

### Motivation
Testing if login documentation exists by installing fresh app and attempting login.

### Findings
**No login documentation existed** - only post-login screens were documented.

#### Discovered Screens
1. **Terms Acceptance** (`StartupActivity`)
   - 2 required checkboxes (UEIP, Privacy/ToU)
   - Continue/Disagree buttons
   - Coordinates documented

2. **Account Selection** (`StartupActivity`)
   - "Create TP-Link ID" button
   - "Log In" button

3. **Login Form** (`LoginActivity`)
   - Email field (AutoCompleteTextView)
   - Password field (password=true)
   - Clear buttons, password toggle (Show/Hide)
   - Remember Me checkbox
   - All coordinates documented

#### ADB Input Limitation Discovered
`adb shell input text` **cannot handle special characters** in passwords:
- `^` → `\%5e` or `\^`
- `"` → `%22` or `&apos;`

**Impact:** Login automation requires workarounds (manual typing, simple password, or Python uiautomator2).

#### Documentation Created
- `screens/login-flow.md` - Complete login flow with coordinates and workarounds

## Files Created/Updated This Session
- `ui-exploration/screens/startup-flows.md` - Comprehensive startup documentation
- `ui-exploration/screens/login-flow.md` - **NEW**: Complete login flow documentation
- `ui-exploration/screenshots/camera-offline-*.png` - Offline state screenshots
- `ui-exploration/screenshots/camera-online-*.png` - Online state screenshots
- `ui-exploration/screenshots/camera-live-*.png` - Live view screenshots
- `progress_actual.md` - Updated exploration status
- `KNOWN_ISSUES.md` - Updated emulator status
- `SESSION_2026-01-11.md` - This file (video investigation + login flow)

## Next Steps
1. **Fix video blackout** - Try different GPU modes, check developer options
2. **Fix ANR issue** - Check logcat, may need app restart handling
3. **Create camera-app skill** - Automate reliable emulator+app startup
4. **Build visual shift detection** - Once video works, implement image diff

## Commands Reference

### Emulator Management
```bash
# List AVDs
~/Android/Sdk/emulator/emulator -list-avds

# Start emulator
~/Android/Sdk/emulator/emulator -avd tapo_playstore -gpu host -no-snapshot -no-audio

# Kill emulator
adb -s emulator-5554 emu kill
```

### App Control
```bash
# Launch Tapo
adb shell am start -n com.tplink.iot/.view.welcome.StartupActivity

# Check current activity
adb shell dumpsys activity activities | grep mResumedActivity

# Take screenshot
adb exec-out screencap -p > /tmp/screen.png
```

### Key Coordinates (320x640 dp)
| Element | Coordinates |
|---------|-------------|
| Camera card (home) | (85, 200) |
| Maybe Later | (160, 603) |
| Got It | (160, 565) |
| Pan & Tilt button | (160, 391) |
| PTZ Left | (108, 592) |
| PTZ Right | (208, 592) |
| PTZ Up | (160, 541) |
| PTZ Down | (160, 625) |
| Exit Privacy Mode | (160, 415) |
