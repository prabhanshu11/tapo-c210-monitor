# Session Log: 2026-01-11 - Emulator Setup & Video Investigation

## Session Goal
Set up camera control + video feed for intelligent home automation experiments.

## Experiments Overview

### Pan Control Experiment (Current Focus)
**Purpose**: Validate the actuator → visual change detection pipeline before attempting the gas knob experiment.

**Components**:
- **Actuator**: PAN control (moves camera left/right) - ✅ **CONFIRMED WORKING**
- **Sensor**: Video feed comparison (detect visual shift)
- **Current blocker**: Video capture not working (MQTT connection failure)

**Why this first**: Pan control is software-controllable via the emulator. If we can detect visual shift from PAN movement, the same pipeline works for any actuator (e.g., robotic arm turning gas knob).

### Gas Knob Experiment (Future)
**Purpose**: Detect gas stove on/off state via visual shift from camera observing the knob.

**Prerequisites**:
1. ✅ PAN control works (confirmed)
2. ❌ Video capture works (blocked - fixing now)
3. ⏳ Visual change detection algorithm
4. ⏳ Physical actuator (robotic arm/servo) to turn knob

## Key Discoveries

### 1. Camera is Cloud-Only (CRITICAL)
**All local ports are closed on the camera (192.168.29.137):**
```
Port 80: closed
Port 443: closed
Port 554: closed (RTSP)
Port 2020: closed (ONVIF)
```

**Implications:**
- pytapo/RTSP/ONVIF will NOT work - no local API
- Tapo app connects via TP-Link cloud relay
- **Android UI automation is the ONLY viable control method**
- Direct protocol reverse engineering requires MITM on cloud HTTPS traffic

### 2. Coordinate System
**Physical screen:** 720x1280 pixels (`adb shell wm size`)
**Logical coordinates (uiautomator):** 320x640 dp
**Density:** 160 dpi (`adb shell wm density`)

**IMPORTANT:** `adb shell input tap` uses **dp coordinates**, NOT physical pixels.
```bash
# CORRECT - use dp coordinates from uiautomator dump
adb shell input tap 160 603

# WRONG - don't scale to physical pixels
adb shell input tap 360 1206
```

### 3. Video Blackout Issue - ROOT CAUSE IDENTIFIED

**Symptom:** Video feed shows briefly (~split second) then blacks out.

**Observations:**
- Video DOES render initially (codec works)
- Then immediately goes black
- PAN/Tilt controls work correctly (verified via physical phone)
- Camera physically responds to emulator commands

**Root Cause (from logcat):**
```
MediaException{errorCode=-2016, method='null', message='Don't exist mqtt connection!'}
Client is not connected (32104)
```
- App uses **MQTT via TP-Link cloud relay** for video streaming
- MQTT connection fails/disconnects on emulator
- Control API uses different pathway (HTTP/REST) - that's why PAN works

**GPU Mode Testing:**
- Tested `-gpu host` (hardware) - blacks out
- Tested `-gpu swiftshader_indirect` (software) - blacks out
- **Conclusion: GPU is NOT the cause**

**Workaround Discovered:**
- "Cameras" tab shows static thumbnail without triggering live stream
- Thumbnail loads successfully without ANR
- Could be used for visual state verification without video

**Current status:** RESOLVED - MQTT cloud relay incompatibility with emulator

### 4. ANR "Not Responding" Issue - ROOT CAUSE IDENTIFIED

**Observation (User):**
- Emulator running with only 2GB RAM (`hw.ramSize = 2048`)
- YouTube 1080p works perfectly (efficient hardware decode)
- When opening Tapo camera live view: **memory spikes and sustains high**
- After spike, entire app becomes slow and unresponsive
- Verified via profiling view showing memory graph

**Root Cause:** Memory leak in video rendering path

**Evidence (Performance Stats View - Image 2):**

**Left side (Tapo app with live view):**
- Red line: **>100% sustained**
- Other metrics: Multiple lines above normal levels
- Memory continues high **even after exiting live view**
- Resident memory: **5025.39 MB** sustained

**Right side (YouTube 1080p after closing Tapo):**
- All lines: **~30%** during playback
- Clean, efficient resource usage
- Properly releases resources

**Confirmed Leak Behavior:**
1. Open Tapo camera live view → memory/CPU spike
2. Exit live view → **resources NOT released** (left side sustained high)
3. Force close Tapo, open YouTube → **drops to 30%** (right side)
4. Leak persists until force close

**Comparison:**
- **Tapo (with leak)**: >100% sustained, 5GB+ memory
- **YouTube 1080p**: ~30% usage, efficient

**Workaround Testing:**

**4GB RAM (FAILED):**
- Increased `hw.ramSize` from 2GB → 4GB
- **Result**: Still shows ANR "Not Responding"
- Can't access fullscreen mode
- Can't access photos/videos UI (crashes)
- Sometimes preview works briefly, then freezes
- Can take photos/recordings quickly, but can't access them via UI
- **Conclusion**: 4GB insufficient for this leak

**6GB RAM (TESTING):**
- Increased `hw.ramSize` from 4GB → 6GB (6074 MB verified)
- MemTotal: 6074336 kB ≈ 5.93 GB
- **Status**: Testing in progress

**Ultimate Workaround:**
- **Must force close app** after viewing camera to reclaim memory
- Leak likely in video decode buffer or MQTT client not cleaning up
- No amount of RAM will "fix" the leak - it's an app bug

**Status:** CONFIRMED - Severe memory leak requiring force close after each camera view

### 4b. Main Thread Blocking - DEEP DIVE (Evening Session)

**Root Cause: libpag.so Recursive Loading**

From logcat analysis:
```
Thread[1,tid=3796,Native,Thread*=...,"main"] recursive attempt to load library
"/data/app/.../libpag.so"
I/Choreographer: Skipped 44 frames! The application may be doing too much work on its main thread.
```

**libpag.so** = **PAG** (Portable Animated Graphics) library by Tencent
- Used for complex UI animations (overlay transitions)
- The 3-button overlay that fades in/out when tapping live view
- The "1/24" camera counter display transitions

**Why It Blocks Main Thread:**
1. PAG library loads on main thread (blocking)
2. Recursive load attempts (library tries to load itself?)
3. Animation calculations run on main thread
4. Constant transitions (show/hide overlays every ~1 minute)

**Measurements:**
| Condition | CPU Usage | Frame Drops |
|-----------|-----------|-------------|
| Home screen | 0% | 0 |
| Camera view (no video) | 50-80% | Few |
| Camera live view | **140-180%** | 34-44 frames/event |
| YouTube 1080p | 30% | 0 |

**Attempts to Fix:**
1. Disable animations - **FAILED** (140% still)
2. Enable GPU (hw.gpu.enabled=yes, mode=host) - **FAILED** (164% initially)
3. Force GPU rendering (debug.hwui.renderer=skiagl) - **FAILED** (140% still)
4. Increase CPU cores (4→8) - **MARGINAL** (reduces peaks)
5. Increase RAM (4GB→9GB) - **NO EFFECT** on CPU

**Conclusion:**
- PAG animations execute on main thread by design
- This is an **app-level issue**, not emulator configuration
- **Cannot be fixed** without modifying the APK

**Implications for Multiple Emulators:**
- Each emulator with Tapo live view: ~150% CPU
- With 12 host cores: **Max 4 concurrent live views** before saturation
- Recommendation: Stagger operations or use snapshot workflows

### 5. Camera Icon States (Home Screen)
| State | Icon | Label |
|-------|------|-------|
| Offline | Gray/muted | "Offline" |
| Online + Privacy ON | Normal | Connected but not streaming |
| Online + Privacy OFF | **Blue** | Actively streaming |

Screenshots saved:
- `camera-offline-home-screen.png`
- `camera-online-streaming-blue-icon.png`
- `camera-live-privacy-mode-active.png`

### 6. Startup Popup Flows
**Third-Party Services popup** appears on fresh launch:
1. Screen 1: Service list (Alexa, Google, SmartThings, IFTTT)
   - Dismiss: `adb shell input tap 160 603` (Maybe Later)
2. Screen 2: Confirmation tutorial
   - Dismiss: `adb shell input tap 160 565` (Got It)

**Privacy Mode** - Camera may be in privacy mode on connect:
- Exit: Tap "Exit Privacy Mode" button in camera live view

### 7. Emulator Setup
**Working configuration:**
```bash
./emulator/emulator -avd tapo_playstore -gpu host -no-snapshot -no-audio -no-boot-anim
```

**AVD details:**
- Name: tapo_playstore, tapo_worker2, tapo_worker3
- System image: android-34;google_apis_playstore;x86_64
- GPU: host (uses RTX 2060 SUPER)

**Dual emulator strategy:**
- Emulator 1 (5554): Feed viewing
- Emulator 2 (5556): PAN control
- Both can access same Tapo account simultaneously

## What Works ✅
- [x] Emulator launches with KVM acceleration
- [x] Tapo app installs and runs
- [x] Camera connects (via cloud)
- [x] **PAN/Tilt controls** - ✅ CONFIRMED WORKING (camera physically moves, verified on phone)
- [x] **Photo capture** - ✅ WORKS (but cannot access photos via UI - app crashes/ANR)
- [x] **Video recording** - ✅ WORKS (but cannot access recordings via UI)
- [x] Privacy Mode toggle works
- [x] UI automation (tap, swipe) works
- [x] Screenshot capture works
- [x] uiautomator dump works

## What Doesn't Work ❌
- [ ] **Video feed display** - blacks out after brief flash (MQTT connection failure)
- [ ] **Accessing photos/videos via UI** - crashes when trying to view them
- [ ] Direct camera API (cloud-only, no local ports)
- [ ] pytapo connection (times out)
- [ ] RTSP stream (port closed)

## Login Flow Discovery (2026-01-11 Evening Session)

### Motivation
Testing if login documentation exists by installing fresh app and attempting login.

### Findings
**No login documentation existed** - only post-login screens were documented.

#### Discovered Screens
1. **Terms Acceptance** (`StartupActivity`)
   - 2 required checkboxes (UEIP, Privacy/ToU)
   - Continue/Disagree buttons
   - Coordinates documented

2. **Account Selection** (`StartupActivity`)
   - "Create TP-Link ID" button
   - "Log In" button

3. **Login Form** (`LoginActivity`)
   - Email field (AutoCompleteTextView)
   - Password field (password=true)
   - Clear buttons, password toggle (Show/Hide)
   - Remember Me checkbox
   - All coordinates documented

#### ADB Input Limitation Discovered
`adb shell input text` **cannot handle special characters** in passwords:
- `^` → `\%5e` or `\^`
- `"` → `%22` or `&apos;`

**Impact:** Login automation requires workarounds (manual typing, simple password, or Python uiautomator2).

#### Documentation Created
- `screens/login-flow.md` - Complete login flow with coordinates and workarounds

## Files Created/Updated This Session
- `ui-exploration/screens/startup-flows.md` - Comprehensive startup documentation
- `ui-exploration/screens/login-flow.md` - **NEW**: Complete login flow documentation
- `ui-exploration/screenshots/camera-offline-*.png` - Offline state screenshots
- `ui-exploration/screenshots/camera-online-*.png` - Online state screenshots
- `ui-exploration/screenshots/camera-live-*.png` - Live view screenshots
- `progress_actual.md` - Updated exploration status
- `KNOWN_ISSUES.md` - Updated emulator status
- `SESSION_2026-01-11.md` - This file (video investigation + login flow)

## Next Steps
1. **Fix video blackout** - Try different GPU modes, check developer options
2. **Fix ANR issue** - Check logcat, may need app restart handling
3. **Create camera-app skill** - Automate reliable emulator+app startup
4. **Build visual shift detection** - Once video works, implement image diff

## Commands Reference

### Emulator Management
```bash
# List AVDs
~/Android/Sdk/emulator/emulator -list-avds

# Start emulator
~/Android/Sdk/emulator/emulator -avd tapo_playstore -gpu host -no-snapshot -no-audio

# Kill emulator
adb -s emulator-5554 emu kill
```

### App Control
```bash
# Launch Tapo
adb shell am start -n com.tplink.iot/.view.welcome.StartupActivity

# Check current activity
adb shell dumpsys activity activities | grep mResumedActivity

# Take screenshot
adb exec-out screencap -p > /tmp/screen.png
```

### Key Coordinates (320x640 dp)
| Element | Coordinates |
|---------|-------------|
| Camera card (home) | (85, 200) |
| Maybe Later | (160, 603) |
| Got It | (160, 565) |
| Pan & Tilt button | (160, 391) |
| PTZ Left | (108, 592) |
| PTZ Right | (208, 592) |
| PTZ Up | (160, 541) |
| PTZ Down | (160, 625) |
| Exit Privacy Mode | (160, 415) |

## Late Session Discoveries (2026-01-11 ~05:15)

### Third-Party Compatibility ENABLED

**Location**: Me tab > Settings > Third-Party Compatibility

**What it does**: Enables integration with open-source home automation platforms like Home Assistant.

**Screenshots saved**:
- `screenshots/2026-01-11-discoveries/01-third-party-compatibility-off.png`
- `screenshots/2026-01-11-discoveries/02-third-party-compatibility-enable-dialog.png`

**Documentation created**: `screens/third-party-compatibility.md`

**Action Required**: Re-scan camera ports to check if RTSP/ONVIF is now available!

### UI Exploration Verification

Checked existing documentation coverage:

| Screen | Documented? | Notes |
|--------|-------------|-------|
| Third-Party Compatibility (Settings) | **NO** → Now documented | New screen discovered |
| Playback & Download | ✅ YES | `screens/playback-download-worker1.md` |
| Camera Memory | ✅ YES | `screens/camera-memory-deep-worker2.md` |
| Me tab > Camera section | ✅ YES | `screens/me-tab-worker-1.md` |

**New screenshots saved**:
- `screenshots/2026-01-11-discoveries/03-me-tab-camera-section.png`
- `screenshots/2026-01-11-discoveries/04-playback-download-timeline.png`
- `screenshots/2026-01-11-discoveries/05-camera-memory-transition.png`
- `screenshots/2026-01-11-discoveries/06-camera-memory-gallery.png`

### Key Finding: Photo/Video Access Works via Me Tab

Previously documented as "works but UI inaccessible" - this was wrong!

**Correct Path**:
- Me tab → Playback & Download → Select camera → Timeline view with detected events
- Me tab → Camera Memory → Grid of photos/videos taken

The ANR/crash issue only occurs when accessing from camera-live view directly. The Me tab route works!

## BREAKTHROUGH: RTSP Access Enabled (2026-01-11 ~05:30)

### What Was Done
1. **Enabled Third-Party Compatibility** (Me tab > Settings)
2. **Rebooted camera** (power cycle required)
3. **Created Camera Account** (Advanced Settings > Camera Account)
   - Username: `prabhanshu`
   - Password: `iamapantar`

### Result: All Ports Now OPEN!

| Port | Protocol | Status |
|------|----------|--------|
| 443 | HTTPS | **OPEN** |
| 554 | RTSP | **OPEN** |
| 2020 | ONVIF | **OPEN** |
| 8800 | TP-Link Proprietary | **OPEN** |

### Camera IP Changed
- **Old IP**: 192.168.29.137
- **New IP**: **192.168.29.183** (after reboot)

### RTSP Stream Working!
```bash
# HD Stream (2304x1296)
ffprobe "rtsp://prabhanshu:iamapantar@192.168.29.183/stream1"

# Capture single frame
ffmpeg -rtsp_transport tcp -i "rtsp://prabhanshu:iamapantar@192.168.29.183/stream1" \
  -frames:v 1 -update 1 /tmp/frame.jpg
```

**Stream Details**:
- Codec: H.264 High Profile
- Resolution: 2304x1296
- Frame rate: 25 fps
- Transport: RTSP over TCP

### Impact on Project
**Android emulator is NO LONGER needed for video capture!**

Direct RTSP access enables:
1. Real-time video streaming to computer
2. Frame capture for visual analysis
3. Integration with Home Assistant
4. Pan Control Experiment can proceed without emulator video issues

### Screenshots
- `07-camera-account-setup-warning.jpg` - RTSP security warning
- `08-network-settings-new-ip.jpg` - New camera IP (192.168.29.183)
- `09-rtsp-first-frame.jpg` - First captured RTSP frame
